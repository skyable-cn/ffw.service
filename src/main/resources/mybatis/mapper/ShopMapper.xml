<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ShopMapper">
    <!--表名 -->
    <sql id="tableName">
		shop
	</sql>

    <!-- 字段 -->
    <sql id="Field">
		SHOP_ID,
		SHOPNAME,
		SHOPDESC,
		SHOPADDRESS,
		AVGMONEY,
		LONGITUDE,
		LATITUDE,
		CONTRACTPERSON,
		CONTRACTPHONE,
		ACCOUNTER,
		CDT,
		SHOPSTATE_ID,
		SHOPTYPE_ID
	</sql>

    <!-- 字段值 -->
    <sql id="FieldValue">
		#{SHOP_ID},
		#{SHOPNAME},
		#{SHOPDESC},
		#{SHOPADDRESS},
		#{AVGMONEY},
		#{LONGITUDE},
		#{LATITUDE},
		#{CONTRACTPERSON},
		#{CONTRACTPHONE},
		#{ACCOUNTER},
		#{CDT},
		#{SHOPSTATE_ID},
		#{SHOPTYPE_ID}
	</sql>

   <select id="listPage" parameterType="page" resultType="pd">
        select
	        s.SHOP_ID,
			s.SHOPNAME,
			s.SHOPDESC,
			s.SHOPADDRESS,
			s.AVGMONEY,
			s.LONGITUDE,
			s.LATITUDE,
			s.CONTRACTPERSON,
			s.CONTRACTPHONE,
			s.ACCOUNTER,
			s.CDT,
			s.SHOPSTATE_ID,
			s.SHOPTYPE_ID,
			ss.SHOPSTATENAME,
			st.SHOPTYPENAME,
			f.FILEPATH
        from
        <include refid="tableName"></include> s
        left join shopstate ss on s.shopstate_id = ss.shopstate_id
        left join shoptype st on s.shoptype_id = st.shoptype_id
        left join file f on s.shop_id = f.reference_id and f.filetype = '7'
        where
        1 = 1
        <if test="pd.keywords!= null and pd.keywords != ''"><!-- 关键词检索 -->
            and
            (
            	s.SHOPNAME LIKE CONCAT(CONCAT('%', #{pd.keywords}),'%')
            )
        </if>
        <if test="pd.SHOPSTATE_ID!= null and pd.SHOPSTATE_ID != ''"><!-- 关键词检索 -->
            and s.SHOPSTATE_ID = #{pd.SHOPSTATE_ID}
        </if>
        order by s.SHOP_ID ASC
    </select>

    <select id="listAll" parameterType="pd" resultType="pd">
       select
	        s.SHOP_ID,
			s.SHOPNAME,
			s.SHOPDESC,
			s.SHOPADDRESS,
			s.AVGMONEY,
			s.LONGITUDE,
			s.LATITUDE,
			s.CONTRACTPERSON,
			s.CONTRACTPHONE,
			s.ACCOUNTER,
			s.CDT,
			s.SHOPSTATE_ID,
			s.SHOPTYPE_ID,
			ss.SHOPSTATENAME,
			st.SHOPTYPENAME,
			f.FILEPATH
        from
        <include refid="tableName"></include> s
        left join shopstate ss on s.shopstate_id = ss.shopstate_id
        left join shoptype st on s.shoptype_id = st.shoptype_id
        left join file f on s.shop_id = f.reference_id and f.filetype = '7'
        where
        1 = 1
        <if test="keywords!= null and keywords != ''"><!-- 关键词检索 -->
            and
            (
            	s.SHOPNAME LIKE CONCAT(CONCAT('%', #{keywords}),'%')
            )
        </if>
        <if test="SHOPSTATE_ID!= null and SHOPSTATE_ID != ''"><!-- 关键词检索 -->
            and s.SHOPSTATE_ID = #{SHOPSTATE_ID}
        </if>
        order by s.SHOP_ID ASC
    </select>
    
    <select id="listAllState" parameterType="pd" resultType="pd">
        select
        	SHOPSTATE_ID,
        	SHOPSTATENAME
        from
        	shopstate
        order by SHOPSTATE_ID ASC
    </select>
    
    <select id="listAllType" parameterType="pd" resultType="pd">
        select
        	SHOPTYPE_ID,
        	SHOPTYPENAME
        from
        	shoptype
        order by SHOPTYPE_ID ASC
    </select>
    
    <select id="listAllApprove" parameterType="pd" resultType="pd">
        select
        	sa.SHOPAPPROVE_ID,
        	ss.SHOPSTATENAME,
        	sa.APPROVECOMMENT,
        	sa.CDT
        from
        	shopapprove sa
        left join shopstate ss on sa.shopstate_id = ss.shopstate_id
        where
        	1 = 1
        <if test="SHOP_ID!= null and SHOP_ID != ''"><!-- 关键词检索 -->
            and sa.SHOP_ID = #{SHOP_ID}
        </if>
        order by sa.cdt desc
    </select>

    <!-- 新增 -->
    <insert id="save" parameterType="pd" useGeneratedKeys="true" keyProperty="SHOP_ID">
        insert into <include refid="tableName"></include> (
        <include refid="Field"></include>
        ) values (
        <include refid="FieldValue"></include>
        )
    </insert>
    
    <insert id="saveApprove" parameterType="pd" useGeneratedKeys="true" keyProperty="SHOPAPPROVE_ID">
        insert into shopapprove values (
        	null,
        	#{SHOP_ID},
        	#{SHOPSTATE_ID},
        	#{APPROVECOMMENT},
        	#{CDT}
        )
    </insert>
    
        <!-- 修改 -->
    <update id="edit" parameterType="pd">
        update
        <include refid="tableName"></include>
        set
        SHOP_ID = #{SHOP_ID}
        <if test="SHOPNAME != null and SHOPNAME != ''">
            ,SHOPNAME = #{SHOPNAME}
        </if>
        <if test="SHOPDESC != null and SHOPDESC != ''">
            ,SHOPDESC = #{SHOPDESC}
        </if>
        <if test="SHOPSTATE_ID != null and SHOPSTATE_ID != ''">
            ,SHOPSTATE_ID = #{SHOPSTATE_ID}
        </if>
        <if test="ACCOUNTER != null and ACCOUNTER != ''">
            ,ACCOUNTER = #{ACCOUNTER}
        </if>
        <if test="SHOPADDRESS != null and SHOPADDRESS != ''">
            ,SHOPADDRESS = #{SHOPADDRESS}
        </if>
        <if test="AVGMONEY != null and AVGMONEY != ''">
            ,AVGMONEY = #{AVGMONEY}
        </if>
        where
        SHOP_ID = #{SHOP_ID}
    </update>
    
    <!-- 删除 -->
    <delete id="delete" parameterType="pd" flushCache="false">
        delete from
        <include refid="tableName"></include>
        where
        SHOP_ID = #{SHOP_ID}
    </delete>
    
    <!-- 通过user_id获取数据 -->
    <select id="findById" parameterType="pd" resultType="pd">
        select
	        s.SHOP_ID,
			s.SHOPNAME,
			s.SHOPDESC,
			s.SHOPADDRESS,
			s.AVGMONEY,
			s.LONGITUDE,
			s.LATITUDE,
			s.CONTRACTPERSON,
			s.CONTRACTPHONE,
			s.ACCOUNTER,
			s.CDT,
			s.SHOPSTATE_ID,
			s.SHOPTYPE_ID,
			ss.SHOPSTATENAME,
			st.SHOPTYPENAME,
			f.FILEPATH
        from
        <include refid="tableName"></include> s
        left join shopstate ss on s.shopstate_id = ss.shopstate_id
        left join shoptype st on s.shoptype_id = st.shoptype_id
        left join file f on s.shop_id = f.reference_id and f.filetype = '7'
        where
        SHOP_ID = #{SHOP_ID}
    </select>
</mapper>